<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>TripFlow v3.3.0 Integrate</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1E88E5',
              secondary: '#FF9800',
              accent: '#4CAF50',
              dark: '#263238',
              light: '#F5F7FA',
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
          },
        },
      }
    </script>

    <style>
      body {
        -webkit-tap-highlight-color: transparent;
        background-color: #f5f7fa;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Âä®Áîª */
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.25s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
      .slide-up-enter-active,
      .slide-up-leave-active {
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .slide-up-enter-from,
      .slide-up-leave-to {
        transform: translateY(100%);
      }
      .expand-enter-active,
      .expand-leave-active {
        transition: all 0.3s ease;
        opacity: 1;
      }
      .expand-enter-from,
      .expand-leave-to {
        max-height: 0;
        opacity: 0;
      }

      /* ÁéªÁíÉÊãüÊÄÅ */
      .glass-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      /* Âú∞ÂõæÊ†áËÆ∞Ëá™ÂÆö‰πâ */
      .custom-div-icon {
        background: #1e88e5;
        color: white;
        border-radius: 50%;
        text-align: center;
        font-weight: bold;
        line-height: 24px;
        font-size: 12px;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }
      .marker-pulse {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(30, 136, 229, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(30, 136, 229, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(30, 136, 229, 0);
        }
      }

      [v-cloak] {
        display: none;
      }
    </style>
  </head>
  <body class="h-[100dvh] flex flex-col text-dark overflow-hidden">
    <div id="app" class="h-full flex flex-col relative" v-cloak>
      <header
        class="glass-header h-[60px] flex items-center justify-between px-4 shrink-0 z-30 shadow-sm"
      >
        <div class="flex items-center gap-2">
          <div
            class="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center text-primary"
          >
            <i class="fa-solid fa-route"></i>
          </div>
          <div class="flex flex-col leading-none">
            <h1 class="font-bold text-lg text-dark">TripFlow</h1>
            <span class="text-[10px] font-medium text-gray-500 mt-0.5" v-if="state.data"
              >{{ state.data.meta.date_range }}</span
            >
          </div>
        </div>

        <button
          @click="toggleMode"
          class="flex items-center gap-2 px-4 py-1.5 rounded-full border transition-all active:scale-95 shadow-sm"
          :class="state.user.mode === 'PLANNER' ? 'bg-dark text-white border-dark' : 'bg-white text-dark border-gray-200'"
        >
          <i class="fa-solid" :class="state.user.mode === 'PLANNER' ? 'fa-map' : 'fa-play'"></i>
          <span class="text-xs font-bold"
            >{{ state.user.mode === 'PLANNER' ? 'ËßÑÂàí' : 'ÊâßË°å' }}</span
          >
        </button>
      </header>

      <main class="flex-1 relative overflow-hidden bg-[#F5F7FA]">
        <transition name="fade" mode="out-in">
          <div
            v-if="state.user.mode === 'PLANNER'"
            key="planner"
            class="h-full overflow-y-auto px-4 py-6 pb-32 space-y-6"
          >
            <section class="grid grid-cols-2 gap-3">
              <div
                class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-start"
              >
                <span class="text-xs text-gray-400 font-bold uppercase mb-1"
                  ><i class="fa-solid fa-wallet mr-1"></i>È¢ÑÁÆó</span
                >
                <span class="text-lg font-bold text-dark"
                  >{{ state.data?.meta?.budget || '-' }}</span
                >
              </div>
              <div
                class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-start"
              >
                <span class="text-xs text-gray-400 font-bold uppercase mb-1"
                  ><i class="fa-solid fa-cloud-sun mr-1"></i>Â§©Ê∞î</span
                >
                <span class="text-sm font-medium text-dark truncate w-full"
                  >{{ weatherSummary }}</span
                >
              </div>
              <div
                class="col-span-2 bg-gradient-to-r from-primary to-blue-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden"
              >
                <i
                  class="fa-solid fa-lightbulb absolute -right-2 -bottom-4 text-6xl opacity-20"
                ></i>
                <div class="relative z-10">
                  <h3 class="font-bold text-sm mb-2 flex items-center">
                    <i class="fa-solid fa-circle-exclamation mr-2"></i>ÂÖ≥ÈîÆÊèêÁ§∫
                  </h3>
                  <div class="space-y-1">
                    <div
                      v-for="(info, i) in keyInfos.slice(0, 2)"
                      :key="i"
                      class="text-xs opacity-90 flex items-start gap-1.5"
                    >
                      <span class="mt-0.5">‚Ä¢</span>
                      <span>{{ info.label }}: {{ info.value }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
              <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-dark flex items-center gap-2">
                  <i class="fa-solid fa-clipboard-check text-accent"></i> ÂáÜÂ§áÊ∏ÖÂçï
                </h2>
                <span
                  class="text-xs font-mono font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded-md"
                  >{{ checklistProgress }}</span
                >
              </div>
              <div class="flex gap-4 border-b border-gray-100 mb-3 overflow-x-auto no-scrollbar">
                <button
                  v-for="cat in checklistCategories"
                  :key="cat.id"
                  @click="ui.activeChecklistTab = cat.id"
                  class="pb-2 text-xs font-bold transition-colors whitespace-nowrap border-b-2"
                  :class="ui.activeChecklistTab === cat.id ? 'text-primary border-primary' : 'text-gray-400 border-transparent hover:text-gray-600'"
                >
                  {{ cat.title.split(' ')[1] || cat.title }}
                </button>
              </div>
              <div class="space-y-2 max-h-40 overflow-y-auto no-scrollbar">
                <label
                  v-for="item in currentChecklistItems"
                  :key="item.id"
                  class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer group transition-colors"
                >
                  <div class="relative flex items-center justify-center">
                    <input
                      type="checkbox"
                      :checked="state.user.checkedItems[item.id]"
                      @change="toggleCheck(item.id)"
                      class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded checked:bg-accent checked:border-accent transition-all"
                    />
                    <i
                      class="fa-solid fa-check absolute text-white text-xs opacity-0 peer-checked:opacity-100 pointer-events-none"
                    ></i>
                  </div>
                  <span
                    class="text-sm text-gray-700 peer-checked:text-gray-400 peer-checked:line-through transition-all"
                    >{{ item.text }}</span
                  >
                </label>
              </div>
            </section>

            <section class="space-y-4">
              <h2 class="font-bold text-dark px-1 flex items-center gap-2">
                <i class="fa-regular fa-calendar-days text-primary"></i> Ë°åÁ®ãÂÆâÊéí
              </h2>

              <div
                v-for="(day, idx) in days"
                :key="day.date"
                class="bg-white rounded-2xl border border-gray-200 overflow-hidden transition-all duration-300"
                :class="ui.expandedDay === idx ? 'shadow-lg border-primary/30 ring-1 ring-primary/20' : 'shadow-sm'"
              >
                <div
                  @click="toggleDay(idx)"
                  class="p-4 cursor-pointer relative z-10 hover:bg-gray-50/50 transition-colors"
                >
                  <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1.5">
                        <span class="text-[10px] font-bold text-white bg-dark px-2 py-0.5 rounded"
                          >Day {{ day.day_index }}</span
                        >
                        <span class="text-xs font-semibold text-gray-400 font-mono"
                          >{{ formatDate(day.date) }}</span
                        >
                      </div>
                      <h3 class="font-bold text-dark text-base leading-tight">{{ day.summary }}</h3>
                    </div>
                    <div
                      class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 text-xs transition-transform duration-300"
                      :class="ui.expandedDay === idx ? 'rotate-180 bg-primary/10 text-primary' : ''"
                    >
                      <i class="fa-solid fa-chevron-down"></i>
                    </div>
                  </div>
                  <div class="h-1.5 bg-gray-100 rounded-full flex overflow-hidden mt-3">
                    <div
                      v-for="(seg, i) in getDaySegments(day)"
                      :key="i"
                      class="rhythm-segment"
                      :class="getSegmentColor(seg.type)"
                      :style="{ width: seg.width + '%' }"
                    ></div>
                  </div>
                </div>

                <div
                  v-if="ui.expandedDay === idx"
                  class="bg-[#FAFBFC] border-t border-gray-100 p-4 space-y-4 expand-enter-active"
                >
                  <div class="grid grid-cols-2 gap-2 mb-4">
                    <div
                      class="bg-white p-2.5 rounded-lg border border-gray-100 shadow-sm flex items-center gap-2"
                    >
                      <div
                        class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"
                      >
                        <i class="fa-solid fa-car"></i>
                      </div>
                      <div>
                        <div class="text-[10px] text-gray-400 font-bold uppercase">‰∫§ÈÄö</div>
                        <div class="text-xs font-bold">{{ calculateStats(day).transport }}È°π</div>
                      </div>
                    </div>
                    <div
                      class="bg-white p-2.5 rounded-lg border border-gray-100 shadow-sm flex items-center gap-2"
                    >
                      <div
                        class="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-orange-500"
                      >
                        <i class="fa-solid fa-utensils"></i>
                      </div>
                      <div>
                        <div class="text-[10px] text-gray-400 font-bold uppercase">È§êÈ•Æ</div>
                        <div class="text-xs font-bold">{{ calculateStats(day).food }}È§ê</div>
                      </div>
                    </div>
                  </div>

                  <button
                    @click.stop="openMapForDay(day)"
                    class="w-full py-3 bg-white text-primary border border-primary/20 text-xs font-bold rounded-xl hover:bg-primary/5 transition-colors flex items-center justify-center gap-2 shadow-sm"
                  >
                    <i class="fa-solid fa-map"></i> Êü•ÁúãÂΩìÊó•Ë∑ØÁ∫øÂõæ
                  </button>

                  <div class="space-y-3 relative">
                    <div class="absolute left-[19px] top-4 bottom-4 w-0.5 bg-gray-200"></div>

                    <div v-for="(item, i) in day.items" :key="item.id" class="relative pl-10 group">
                      <div
                        class="absolute left-[13px] top-3 w-3.5 h-3.5 rounded-full border-2 border-white shadow-sm z-10"
                        :class="item.status === 'anchor' ? 'bg-secondary' : 'bg-primary'"
                      ></div>

                      <div
                        class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow"
                      >
                        <div class="flex justify-between items-start mb-1">
                          <span
                            class="text-xs font-mono font-bold text-gray-500 bg-gray-50 px-1.5 py-0.5 rounded"
                            >{{ item.time }}</span
                          >
                          <span class="text-xs text-gray-400"
                            ><i :class="getTypeIcon(item.type)"></i
                          ></span>
                        </div>
                        <div class="font-bold text-sm text-dark mb-1">{{ item.name }}</div>
                        <div
                          v-if="item.description"
                          class="text-xs text-gray-500 line-clamp-2 mb-2"
                        >
                          {{ item.description }}
                        </div>

                        <div class="flex flex-wrap gap-2">
                          <a
                            v-if="item.coords"
                            :href="getNavUrl(item)"
                            target="_blank"
                            @click.stop
                            class="text-[10px] px-2 py-1 bg-blue-50 text-blue-600 rounded-md font-bold hover:bg-blue-100 transition-colors"
                          >
                            <i class="fa-solid fa-location-arrow mr-1"></i>ÂØºËà™
                          </a>
                          <span
                            v-if="item.booking"
                            class="text-[10px] px-2 py-1 bg-orange-50 text-orange-600 rounded-md font-mono border border-orange-100"
                          >
                            {{ item.booking.code }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <div v-else key="flow" class="h-full flex flex-col">
            <div
              class="p-4 z-10 sticky top-0 bg-gradient-to-b from-[#F5F7FA] via-[#F5F7FA] to-transparent pb-4"
            >
              <div
                v-if="focusInfo.item"
                class="bg-white rounded-3xl p-6 shadow-xl shadow-primary/5 border border-white/50 relative overflow-hidden group"
              >
                <div
                  class="absolute -right-6 -top-6 w-32 h-32 bg-primary/5 rounded-full blur-2xl group-hover:bg-primary/10 transition-colors"
                ></div>

                <div class="flex justify-between items-center mb-4 relative z-10">
                  <div class="flex items-center gap-2">
                    <span class="relative flex h-2.5 w-2.5" v-if="focusInfo.status === 'ONGOING'">
                      <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent opacity-75"
                      ></span>
                      <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-accent"></span>
                    </span>
                    <span
                      class="text-xs font-bold px-2 py-1 rounded-md uppercase tracking-wide border"
                      :class="focusInfo.status === 'ONGOING' ? 'bg-green-50 text-accent border-green-100' : 'bg-orange-50 text-secondary border-orange-100'"
                    >
                      {{ focusInfo.status === 'ONGOING' ? 'Ê≠£Âú®ËøõË°å' : 'Âç≥Â∞ÜÂºÄÂßã' }}
                    </span>
                  </div>
                  <div
                    class="font-mono text-xs font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-full"
                  >
                    {{ focusInfo.timeLeft }}
                  </div>
                </div>

                <h2 class="text-2xl font-bold text-dark leading-tight mb-2 relative z-10">
                  {{ focusInfo.item.name }}
                </h2>
                <div
                  class="flex items-center gap-3 text-sm text-gray-500 font-mono mb-6 relative z-10"
                >
                  <span class="bg-gray-100 px-1.5 rounded flex items-center gap-1"
                    ><i class="fa-regular fa-clock text-xs"></i> {{ focusInfo.item.time }}</span
                  >
                  <i class="fa-solid fa-arrow-right text-xs text-gray-300"></i>
                  <span class="bg-gray-100 px-1.5 rounded"
                    >{{ focusInfo.item.end_time || '?' }}</span
                  >
                </div>

                <div class="grid grid-cols-2 gap-3 relative z-10">
                  <a
                    :href="getNavUrl(focusInfo.item)"
                    target="_blank"
                    class="flex items-center justify-center gap-2 bg-primary text-white py-3.5 rounded-xl font-bold hover:bg-blue-600 active:scale-95 transition-all shadow-lg shadow-blue-200"
                  >
                    <i class="fa-solid fa-location-arrow"></i> ÂØºËà™
                  </a>
                  <div
                    v-if="focusInfo.item.booking"
                    class="flex flex-col items-center justify-center bg-gray-50 border border-gray-100 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer"
                    @click="copyText(focusInfo.item.booking.code)"
                  >
                    <span class="text-[9px] text-gray-400 uppercase font-bold tracking-wider"
                      >TICKET CODE</span
                    >
                    <span class="font-mono font-bold text-dark text-sm"
                      >{{ focusInfo.item.booking.code }}</span
                    >
                  </div>
                  <button
                    v-else
                    @click="openMapForFlow"
                    class="flex flex-col items-center justify-center bg-white border border-gray-200 rounded-xl text-primary font-bold text-sm hover:bg-gray-50 transition-colors"
                  >
                    <i class="fa-solid fa-map"></i> Âú∞Âõæ
                  </button>
                </div>
              </div>

              <div
                v-else
                class="bg-white rounded-3xl p-8 text-center border border-gray-100 shadow-sm"
              >
                <div
                  class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"
                >
                  üåô
                </div>
                <h2 class="font-bold text-dark text-lg">‰ªäÊó•Ë°åÁ®ãÂ∑≤ÁªìÊùü</h2>
                <p class="text-gray-400 text-sm mt-2">Â•ΩÂ•Ω‰ºëÊÅØÔºåÂáÜÂ§áÊòéÂ§©ÁöÑÊóÖÁ®ã</p>
              </div>
            </div>

            <div class="flex-1 overflow-y-auto px-4 pb-24 no-scrollbar space-y-4">
              <div
                v-if="pastItems.length"
                class="border border-gray-200 rounded-xl bg-gray-50 overflow-hidden"
              >
                <div
                  @click="ui.showPastItems = !ui.showPastItems"
                  class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors"
                >
                  <span
                    class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2"
                  >
                    <i class="fa-solid fa-clock-rotate-left"></i> Â∑≤ÁªìÊùü ({{ pastItems.length }})
                  </span>
                  <i
                    class="fa-solid fa-chevron-down text-xs text-gray-300 transition-transform"
                    :class="ui.showPastItems ? 'rotate-180' : ''"
                  ></i>
                </div>
                <div
                  v-if="ui.showPastItems"
                  class="bg-white border-t border-gray-100 p-2 space-y-1"
                >
                  <div
                    v-for="item in pastItems"
                    :key="item.id"
                    class="flex gap-3 p-2 rounded-lg opacity-60 grayscale hover:opacity-100 hover:grayscale-0 transition-all"
                  >
                    <div class="text-xs font-mono text-gray-400 w-10 text-right">
                      {{ item.time }}
                    </div>
                    <div class="text-xs font-bold text-gray-600 line-through decoration-gray-300">
                      {{ item.name }}
                    </div>
                  </div>
                </div>
              </div>

              <div
                v-for="(item, idx) in futureItems"
                :key="item.id"
                class="flex group mb-0"
                :class="{ 'opacity-50 grayscale': state.user.doneItems[item.id] }"
              >
                <div
                  class="w-12 text-right pt-2 pr-3 text-xs font-mono font-bold text-gray-400 shrink-0"
                >
                  {{ item.time }}
                </div>
                <div class="relative flex flex-col items-center mr-3">
                  <div
                    class="w-3.5 h-3.5 rounded-full border-2 border-white shadow-sm z-10 transition-colors"
                    :class="[item.status === 'anchor' ? 'bg-secondary' : 'bg-primary', item.status === 'option' ? 'bg-gray-300' : '']"
                  ></div>
                  <div
                    class="w-0.5 bg-gray-200 flex-1 my-0.5 group-last:bg-transparent"
                    :class="item.status === 'option' ? 'border-l border-gray-300 border-dashed bg-transparent w-0' : ''"
                  ></div>
                </div>
                <div class="flex-1 pb-6">
                  <div
                    @click="toggleExpandedItem(item.id)"
                    class="bg-white rounded-xl p-3.5 shadow-sm border border-gray-100 active:scale-[0.99] transition-transform cursor-pointer relative overflow-hidden group-hover:border-gray-300"
                    :class="ui.expandedStreamItem === item.id ? 'ring-1 ring-primary border-primary' : ''"
                  >
                    <div class="flex justify-between items-start">
                      <div class="flex flex-col">
                        <h3
                          class="font-bold text-dark text-sm leading-snug"
                          :class="item.status === 'option' ? 'text-gray-500 italic' : ''"
                        >
                          <span
                            v-if="item.status === 'option'"
                            class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded mr-1 not-italic font-normal"
                            >Plan B</span
                          >{{ item.name }}
                        </h3>
                      </div>
                      <div
                        @click.stop="toggleDone(item.id)"
                        class="w-5 h-5 rounded border border-gray-200 flex items-center justify-center transition-colors shrink-0 ml-2 hover:border-primary"
                        :class="state.user.doneItems[item.id] ? 'bg-accent border-accent text-white' : 'bg-white'"
                      >
                        <i
                          class="fa-solid fa-check text-xs"
                          v-if="state.user.doneItems[item.id]"
                        ></i>
                      </div>
                    </div>

                    <div class="flex gap-2 mt-2 items-center">
                      <span class="text-sm text-gray-400"
                        ><i :class="getTypeIcon(item.type)"></i
                      ></span>
                      <span
                        v-if="item.type"
                        class="text-[10px] bg-gray-50 text-gray-500 px-1.5 py-0.5 rounded uppercase border border-gray-100"
                        >{{ item.type }}</span
                      >
                    </div>

                    <div
                      v-if="ui.expandedStreamItem === item.id"
                      class="mt-3 pt-3 border-t border-gray-50 expand-enter-active"
                    >
                      <p v-if="item.description" class="text-xs text-gray-600 mb-3 leading-relaxed">
                        {{ item.description }}
                      </p>
                      <div class="flex gap-2">
                        <a
                          v-if="item.coords"
                          :href="getNavUrl(item)"
                          target="_blank"
                          @click.stop
                          class="flex-1 py-2 bg-blue-50 text-primary text-xs font-bold rounded-lg text-center hover:bg-blue-100"
                        >
                          <i class="fa-solid fa-diamond-turn-right mr-1"></i> ÂØºËà™
                        </a>
                        <div
                          v-if="item.booking"
                          class="flex-1 py-2 bg-orange-50 text-secondary text-xs font-bold rounded-lg text-center font-mono border border-orange-100"
                        >
                          {{ item.booking.code }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="tomorrowItems.length" class="pb-6">
                <div
                  class="bg-gradient-to-br from-indigo-50 to-white rounded-xl p-4 border border-indigo-100 text-center cursor-pointer hover:shadow-md transition-all group"
                  @click="toggleMode"
                >
                  <h3
                    class="font-bold text-indigo-900 text-sm mb-1 group-hover:text-indigo-600 transition-colors"
                  >
                    üåÖ ÊòéÊó•Ë°åÁ®ãÈ¢ÑËßà
                  </h3>
                  <p class="text-xs text-indigo-400">ÁÇπÂáªÂàáÊç¢Âà∞ËßÑÂàíÊ®°ÂºèÊü•ÁúãËØ¶ÊÉÖ</p>
                </div>
              </div>
            </div>
          </div>
        </transition>
      </main>

      <div v-if="ui.isMapOpen" class="fixed inset-0 z-50 flex flex-col justify-end">
        <div
          class="absolute inset-0 bg-dark/20 backdrop-blur-sm transition-opacity"
          @click="closeMap"
        ></div>
        <div
          class="bg-white h-[65vh] rounded-t-2xl shadow-2xl z-10 flex flex-col overflow-hidden relative slide-up-enter-active"
        >
          <div
            class="p-3 flex justify-center bg-white border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
            @click="closeMap"
          >
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
          </div>
          <div id="map-container" class="flex-1 bg-gray-100 relative"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        createApp,
        reactive,
        computed,
        ref,
        onMounted,
        nextTick,
      } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
      import { addDays } from 'https://esm.sh/date-fns@2.30.0'
      import * as L from 'https://esm.sh/leaflet@1.9.4'

      createApp({
        setup() {
          const state = reactive({
            data: null,
            user: { mode: 'PLANNER', modeSource: 'AUTO', checkedItems: {}, doneItems: {} },
          })

          const ui = reactive({
            isMapOpen: false,
            expandedDay: null,
            activeChecklistTab: null,
            showPastItems: false,
            expandedStreamItem: null,
          })

          // Â∑•ÂÖ∑ÂáΩÊï∞
          const formatDate = (d) => {
            const date = new Date(d)
            return `${date.getMonth() + 1}Êúà${date.getDate()}Êó•`
          }
          const getNavUrl = (item) =>
            item?.coords ? `http://maps.apple.com/?q=${item.coords[0]},${item.coords[1]}` : '#'

          const getTypeIcon = (t) => {
            const map = {
              transport: 'fa-solid fa-plane-departure',
              sight: 'fa-solid fa-camera',
              food: 'fa-solid fa-utensils',
              hotel: 'fa-solid fa-bed',
              flight: 'fa-solid fa-plane',
              shopping: 'fa-solid fa-bag-shopping',
            }
            return map[t] || 'fa-solid fa-location-dot'
          }

          const parseTripTime = (dateStr, timeStr, endTimeStr) => {
            const s = new Date(`${dateStr}T${timeStr}`)
            let e = s
            if (endTimeStr) {
              e = new Date(`${dateStr}T${endTimeStr}`)
              if (e < s) e = addDays(e, 1)
            } else e = new Date(s.getTime() + 3600000)
            return { start: s, end: e }
          }

          // ËÆ°ÁÆóÂ±ûÊÄß
          const days = computed(() => state.data?.days || [])
          const keyInfos = computed(() => state.data?.pre_trip?.key_info || [])
          const weatherSummary = computed(
            () => state.data?.pre_trip?.weather_guide?.split('Ôºå')[0] || 'Êô¥',
          )

          const checklistCategories = computed(() => state.data?.pre_trip?.checklists || [])
          const currentChecklistItems = computed(
            () =>
              checklistCategories.value.find((c) => c.id === ui.activeChecklistTab)?.items || [],
          )
          const checklistProgress = computed(() => {
            if (!checklistCategories.value.length) return '0%'
            let total = 0,
              checked = 0
            checklistCategories.value.forEach((c) =>
              c.items.forEach((i) => {
                total++
                if (state.user.checkedItems[i.id]) checked++
              }),
            )
            return total ? Math.round((checked / total) * 100) + '%' : '0%'
          })

          const risks = computed(() => {
            if (!days.value.length) return []
            const res = []
            days.value.forEach((d) => {
              if (!d.items.some((i) => i.type === 'hotel'))
                res.push({ level: 'danger', message: `Day ${d.day_index} Áº∫Â∞ë‰ΩèÂÆøÂÆâÊéí` })
            })
            return res
          })

          // ÁÑ¶ÁÇπÈÄªËæë
          const now = ref(new Date())
          setInterval(() => (now.value = new Date()), 60000)

          const focusInfo = computed(() => {
            if (!days.value.length) return { item: null }
            const flat = []
            days.value.forEach((d) =>
              d.items.forEach((i) =>
                flat.push({
                  item: i,
                  dayIdx: d.day_index,
                  ...parseTripTime(d.date, i.time, i.end_time),
                }),
              ),
            )

            const ts = now.value.getTime()
            const ongoing = flat.find((x) => ts >= x.start && ts < x.end)
            if (ongoing)
              return {
                status: 'ONGOING',
                item: ongoing.item,
                timeLeft: `Ââ©${Math.max(0, Math.floor((ongoing.end - ts) / 60000))}m`,
              }

            const upcoming = flat.find((x) => ts < x.start)
            if (upcoming)
              return {
                status: 'UPCOMING',
                item: upcoming.item,
                timeLeft: `${Math.floor((upcoming.start - ts) / 60000)}mÂêé`,
              }

            return { item: null }
          })

          const currentDayItems = computed(() => {
            if (!focusInfo.value.item) return []
            const day = days.value.find((d) =>
              d.items.some((i) => i.id === focusInfo.value.item.id),
            )
            return day ? day.items : []
          })

          const pastItems = computed(() => {
            if (!focusInfo.value.item) return []
            const idx = currentDayItems.value.findIndex((i) => i.id === focusInfo.value.item.id)
            return idx > 0 ? currentDayItems.value.slice(0, idx) : []
          })

          const futureItems = computed(() => {
            if (!focusInfo.value.item) return []
            const idx = currentDayItems.value.findIndex((i) => i.id === focusInfo.value.item.id)
            return currentDayItems.value.slice(idx + 1)
          })

          const tomorrowItems = computed(() => {
            if (!focusInfo.value.item) return []
            const idx = days.value.findIndex((d) =>
              d.items.some((i) => i.id === focusInfo.value.item.id),
            )
            return idx >= 0 && idx < days.value.length - 1 ? days.value[idx + 1].items : []
          })

          // ÂàùÂßãÂåñ
          const init = async () => {
            try {
              const res = await fetch('./data.json')
              state.data = await res.json()
              const local = localStorage.getItem('tripflow_v330_user')
              if (local) state.user = { ...state.user, ...JSON.parse(local) }
              if (checklistCategories.value.length)
                ui.activeChecklistTab = checklistCategories.value[0].id
            } catch (e) {
              console.error(e)
            }
          }

          // Êìç‰Ωú
          const toggleMode = () => {
            state.user.mode = state.user.mode === 'PLANNER' ? 'FLOW' : 'PLANNER'
            save()
          }
          const toggleCheck = (id) => {
            state.user.checkedItems[id] = !state.user.checkedItems[id]
            save()
          }
          const toggleDone = (id) => {
            state.user.doneItems[id] = !state.user.doneItems[id]
            save()
          }
          const toggleDay = (idx) => (ui.expandedDay = ui.expandedDay === idx ? null : idx)
          const toggleExpandedItem = (id) =>
            (ui.expandedStreamItem = ui.expandedStreamItem === id ? null : id)
          const save = () => localStorage.setItem('tripflow_v330_user', JSON.stringify(state.user))
          const copyText = (t) => {
            navigator.clipboard.writeText(t)
            alert('Â∑≤Â§çÂà∂')
          }

          // ÁªüËÆ°ËæÖÂä©
          const calculateStats = (day) => {
            return {
              transport: day.items.filter((i) => i.type === 'transport' || i.type === 'flight')
                .length,
              food: day.items.filter((i) => i.type === 'food').length,
            }
          }

          // ËßÜËßâËæÖÂä©
          const getDaySegments = (day) => {
            const total = day.items.length || 1
            return day.items.map((i) => ({
              type: ['transport', 'anchor'].includes(i.status) ? 'anchor' : 'normal',
              width: 100 / total,
            }))
          }
          const getSegmentColor = (t) => (t === 'anchor' ? 'bg-secondary' : 'bg-primary')

          // Âú∞ÂõæÈÄªËæë
          let map = null,
            routeLayer = null,
            markersLayer = null
          const renderMap = (items) => {
            if (!document.getElementById('map-container')) return
            if (!map) {
              map = L.map('map-container', { zoomControl: false }).setView([0, 0], 13)
              L.tileLayer(
                'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                { attribution: '¬© CARTO' },
              ).addTo(map)
              routeLayer = L.layerGroup().addTo(map)
              markersLayer = L.layerGroup().addTo(map)
            }
            routeLayer.clearLayers()
            markersLayer.clearLayers()

            const validItems = items.filter((i) => i.coords)
            if (!validItems.length) return

            const points = validItems.map((i) => i.coords)

            // ÁªòÂà∂ËøûÁ∫ø
            if (points.length > 1) {
              L.polyline(points, {
                color: '#1E88E5',
                weight: 4,
                opacity: 0.7,
                dashArray: '5, 10',
                lineCap: 'round',
              }).addTo(routeLayer)
            }

            // ÁªòÂà∂Â∏¶Â∫èÂè∑ÁöÑ Marker
            validItems.forEach((item, idx) => {
              const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `${idx + 1}`,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
              })
              L.marker(item.coords, { icon }).addTo(markersLayer).bindPopup(item.name)
            })

            map.fitBounds(L.latLngBounds(points), { padding: [50, 50] })
          }

          const openMapForDay = (day) => {
            ui.isMapOpen = true
            nextTick(() => renderMap(day.items))
          }
          const openMapForFlow = () => {
            ui.isMapOpen = true
            const items = []
            if (focusInfo.value.item) items.push(focusInfo.value.item)
            if (futureItems.value.length) items.push(futureItems.value[0])
            nextTick(() => renderMap(items))
          }
          const closeMap = () => (ui.isMapOpen = false)

          onMounted(init)

          return {
            state,
            ui,
            days,
            risks,
            checklistCategories,
            currentChecklistItems,
            checklistProgress,
            keyInfos,
            weatherSummary,
            focusInfo,
            pastItems,
            futureItems,
            tomorrowItems,
            toggleMode,
            toggleCheck,
            toggleDone,
            toggleDay,
            toggleExpandedItem,
            copyText,
            formatDate,
            getTypeIcon,
            getNavUrl,
            getDaySegments,
            getSegmentColor,
            calculateStats,
            openMapForDay,
            openMapForFlow,
            closeMap,
          }
        },
      }).mount('#app')
    </script>
  </body>
</html>
